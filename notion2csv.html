<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notion2CSV | AutoLab</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0F172A;
      color: #E2E8F0;
      padding: 40px 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { color: #38BDF8; text-align: center; }
    .warning {
      background: #1E293B;
      border-left: 4px solid #F59E0B;
      padding: 15px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
    }
    .input-group {
      margin: 20px 0;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      background: #1E293B;
      color: #E2E8F0;
      border: 1px solid #334155;
      border-radius: 8px;
      font-family: 'Inter', monospace;
      margin-top: 8px;
    }
    button {
      background: #38BDF8;
      color: #0F172A;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { opacity: 0.9; }
    button:disabled {
      background: #64748B;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
    }
    textarea#csvOutput {
      height: 200px;
      font-family: monospace;
    }
    a { color: #38BDF8; text-decoration: none; }
  </style>
</head>
<body>
  <h1>Notion2CSV</h1>
  
  <div class="warning">
    ‚ö†Ô∏è <strong>Advertencia de seguridad:</strong> Nunca compartas tu token de Notion.  
    Esta herramienta se ejecuta en tu navegador, pero tu token se env√≠a a la API de Notion.  
    Usa solo con integraciones de confianza.
  </div>

  <p>Exporta tu base de datos de Notion a CSV directamente desde el navegador.</p>

  <div class="input-group">
    <label for="notionToken">Token de integraci√≥n de Notion</label>
    <input type="password" id="notionToken" placeholder="secret_abc123..." autocomplete="off">
  </div>

  <div class="input-group">
    <label for="databaseId">Database ID (de la URL de Notion)</label>
    <input type="text" id="databaseId" placeholder="9b3a... (copia la parte larga de la URL)">
  </div>

  <button onclick="fetchNotionData()">Exportar a CSV</button>
  <button onclick="downloadCSV()" id="downloadBtn" disabled>Descargar CSV</button>

  <div class="result">
    <h3>Resultado:</h3>
    <textarea id="csvOutput" readonly placeholder="El CSV aparecer√° aqu√≠ despu√©s de exportar..."></textarea>
  </div>

  <p>
    ¬øNo sabes c√≥mo obtener estos datos?  
    <a href="https://www.notion.so/help/create-integrations-with-the-notion-api" target="_blank">Gu√≠a oficial de Notion</a>
  </p>

  <p><a href="index.html">&larr; Volver a AutoLab</a></p>

  <script>
    let csvContent = '';

    async function fetchNotionData() {
      const token = document.getElementById('notionToken').value.trim();
      let dbId = document.getElementById('databaseId').value.trim();
      const output = document.getElementById('csvOutput');
      const btn = document.getElementById('downloadBtn');

      if (!token || !dbId) {
        output.value = 'Por favor, introduce tu token y database ID.';
        return;
      }

      // Limpiar el Database ID: eliminar guiones y caracteres no hexadecimales
      dbId = dbId.replace(/[^a-f0-9]/gi, '');
      if (dbId.length < 32) {
        output.value = '‚ö†Ô∏è El Database ID parece inv√°lido. Aseg√∫rate de copiar la parte larga de la URL de Notion.';
        return;
      }

      output.value = 'Conectando con Notion...\n(Esto puede tardar unos segundos)';
      btn.disabled = true;

      try {
        // üîß Correcci√≥n cr√≠tica: eliminar espacio en la URL
        const response = await fetch(`https://api.notion.com/v1/databases/${dbId}/query`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Notion-Version': '2022-06-28',
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          let errorMsg = `Error ${response.status}`;
          try {
            const errorJson = JSON.parse(errorText);
            errorMsg += `: ${errorJson.message || errorText}`;
          } catch {
            errorMsg += `: ${errorText}`;
          }
          throw new Error(errorMsg);
        }

        const data = await response.json();
        csvContent = convertToCSV(data.results);
        output.value = csvContent;
        btn.disabled = false;
      } catch (err) {
        output.value = `‚ùå Error: ${err.message}\n\nüí° Consejo: Aseg√∫rate de que tu base de datos est√° compartida con la integraci√≥n.`;
        console.error(err);
        btn.disabled = true;
      }
    }

    function convertToCSV(pages) {
      if (pages.length === 0) return "La base de datos est√° vac√≠a.";

      // Recopilar todas las propiedades √∫nicas
      const allProps = new Set();
      pages.forEach(page => {
        Object.keys(page.properties).forEach(prop => allProps.add(prop));
      });
      const headers = Array.from(allProps).sort();

      let csv = headers.map(h => `"${String(h).replace(/"/g, '""')}"`).join(',') + '\n';

      for (const page of pages) {
        const row = [];
        for (const prop of headers) {
          const value = extractValue(page.properties?.[prop]);
          row.push(`"${String(value).replace(/"/g, '""')}"`);
        }
        csv += row.join(',') + '\n';
      }
      return csv;
    }

    function extractValue(prop) {
      if (!prop) return '';

      const type = prop.type;

      // Tipos b√°sicos
      if (type === 'title' && prop.title?.[0]) {
        return prop.title[0].plain_text;
      }
      if (type === 'rich_text' && prop.rich_text?.[0]) {
        return prop.rich_text[0].plain_text;
      }
      if (type === 'number') return prop.number;
      if (type === 'select' && prop.select) return prop.select.name;
      if (type === 'multi_select' && prop.multi_select?.length) {
        return prop.multi_select.map(i => i.name).join('; ');
      }
      if (type === 'checkbox') return prop.checkbox;
      if (type === 'date' && prop.date) return prop.date.start;
      if (['url', 'email', 'phone_number'].includes(type)) return prop[type];
      
      // Tipos adicionales √∫tiles
      if (type === 'formula') {
        const formula = prop.formula;
        if (!formula) return '';
        switch (formula.type) {
          case 'string': return formula.string || '';
          case 'number': return formula.number;
          case 'boolean': return formula.boolean;
          case 'date': return formula.date?.start || '';
        }
      }
      if (type === 'people' && prop.people?.length) {
        return prop.people.map(p => p.name || p.id).join('; ');
      }
      if (type === 'created_time') return prop.created_time;
      if (type === 'last_edited_time') return prop.last_edited_time;
      if (type === 'created_by' && prop.created_by) return prop.created_by.name || prop.created_by.id;
      if (type === 'last_edited_by' && prop.last_edited_by) return prop.last_edited_by.name || prop.last_edited_by.id;

      // Relaciones (IDs)
      if (type === 'relation' && prop.relation?.length) {
        return prop.relation.map(r => r.id).join('; ');
      }

      return '';
    }

    function downloadCSV() {
      if (!csvContent) return;

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'notion_export.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>